<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - RemixMeals</title>

  <!-- Materialize CSS & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <style>
    body {
      padding: 30px;
      background-color: #f5f5f5;
      font-family: 'Poppins', sans-serif;
    }
    .card-panel h5 {
      font-weight: 600;
    }
    .dashboard-metrics {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .dashboard-actions {
      margin-top: 40px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h4 class="center-align">üë®‚Äçüíº Admin Dashboard</h4>

    <div class="dashboard-metrics row">
      <div class="col s12 m6">
        <div class="card-panel green lighten-4">
          <h5><i class="material-icons left">group</i>Total Users</h5>
          <p id="user-count" class="flow-text green-text text-darken-4">Loading...</p>
        </div>
      </div>

      <div class="col s12 m6">
        <div class="card-panel orange lighten-4">
          <h5><i class="material-icons left">restaurant_menu</i>Total Recipes</h5>
          <p id="recipe-count" class="flow-text orange-text text-darken-4">Loading...</p>
        </div>
      </div>
    </div>

    <div class="dashboard-actions center-align">
      <a href="manage-users.html" class="btn-large green"><i class="material-icons left">group</i>Manage Users</a>
      <a href="manage-recipes.html" class="btn-large orange"><i class="material-icons left">restaurant_menu</i>Manage Recipes</a>
    </div>

    <div class="center-align" style="margin-top: 30px;">
      <button class="btn red" onclick="logout()">
        <i class="material-icons left">exit_to_app</i>Logout
      </button>
    </div>
  </div>
  
  <script src="js/auth.js"></script>
  <script>
    //Just added this
    document.addEventListener('DOMContentLoaded', () => {
      const user = getLoggedInUser();
      if (!user || !user.isAdmin) {
        M.toast({ html: 'Access denied: Admins only', classes: 'red' });
        window.location.href = 'index.html'; // or login.html
      }
    });
    document.addEventListener('DOMContentLoaded', async () => {
      const token = getToken();
      if (!token) return (window.location.href = 'login.html');

      try {
        const [userRes, recipeRes] = await Promise.all([
          fetch('/api/admin/users', { headers: { Authorization: `Bearer ${token}` } }),
          fetch('/api/recipes?limit=1000', { headers: { Authorization: `Bearer ${token}` } }),
        ]);

        const usersData = await userRes.json();
        const recipesData = await recipeRes.json();

        const userCount = usersData.users.filter(u => !u.isAdmin).length;
        document.getElementById('user-count').textContent = userCount;

        const recipeCount = recipesData.count || recipesData.recipes?.length || 0;
        document.getElementById('recipe-count').textContent = recipeCount;
      } catch (err) {
        console.error('Dashboard fetch error:', err);
      }
    });

    function logout() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = 'login.html';
    }
  </script>

</body>
</html>
